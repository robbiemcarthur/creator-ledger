name: Deploy to Oracle Cloud

on:
  workflow_run:
    workflows: ["CI"]
    branches: [master]
    types:
      - completed

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Copy docker-compose to VM
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.ORACLE_CLOUD_HOST }}
          username: ${{ secrets.ORACLE_CLOUD_USER }}
          key: ${{ secrets.ORACLE_CLOUD_SSH_KEY }}
          source: "docker-compose.external-db.yml"
          target: "/home/ubuntu/creator-ledger/"
          strip_components: 0

      - name: Deploy to Oracle Cloud
        uses: appleboy/ssh-action@v1.0.3
        env:
          DB_URL: ${{ secrets.NEON_DATABASE_URL }}
          DB_USERNAME: ${{ secrets.NEON_DATABASE_USERNAME }}
          DB_PASSWORD: ${{ secrets.NEON_DATABASE_PASSWORD }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}
        with:
          host: ${{ secrets.ORACLE_CLOUD_HOST }}
          username: ${{ secrets.ORACLE_CLOUD_USER }}
          key: ${{ secrets.ORACLE_CLOUD_SSH_KEY }}
          envs: DB_URL,DB_USERNAME,DB_PASSWORD,GITHUB_TOKEN,GITHUB_ACTOR
          script_stop: true
          script: |
            set -e  # Exit on any error

            echo "Starting automated deployment..."

            # Create deployment directory if it doesn't exist
            mkdir -p /home/ubuntu/creator-ledger
            cd /home/ubuntu/creator-ledger

            # Create .env file from secrets
            cat > .env << ENVFILE
            # Spring Profile
            SPRING_PROFILES_ACTIVE=prod

            # Database Configuration (Neon PostgreSQL)
            SPRING_DATASOURCE_URL=${DB_URL}
            SPRING_DATASOURCE_USERNAME=${DB_USERNAME}
            SPRING_DATASOURCE_PASSWORD=${DB_PASSWORD}

            # Application Configuration
            APP_PORT=8080

            # Docker Image
            GITHUB_REPOSITORY=robbiemcarthur/creator-ledger
            IMAGE_TAG=latest

            # SSH Action Variables (suppress warnings)
            DRONE_SSH_PREV_COMMAND_EXIT_CODE=
            ENVFILE

            echo "✅ Environment file created"

            # Verify docker-compose file exists
            if [ ! -f docker-compose.external-db.yml ]; then
              echo "ERROR: docker-compose.external-db.yml not found!"
              ls -la
              exit 1
            fi
            echo "✅ docker-compose.external-db.yml found"

            echo "Logging in to GitHub Container Registry..."
            echo ${GITHUB_TOKEN} | docker login ghcr.io -u ${GITHUB_ACTOR} --password-stdin || { echo "ERROR: Docker login failed!"; exit 1; }

            echo "Pulling latest image..."
            docker compose -f docker-compose.external-db.yml pull app || { echo "ERROR: Failed to pull image!"; exit 1; }

            echo "Deploying application..."
            docker compose -f docker-compose.external-db.yml up -d app || { echo "ERROR: Failed to start container!"; exit 1; }

            echo "Checking initial container status..."
            sleep 5
            docker ps -a | grep creator-ledger-app

            echo ""
            echo "Initial container logs:"
            docker logs creator-ledger-app --tail 30

            echo ""
            echo "Waiting for application to be healthy..."
            RETRY_COUNT=0
            MAX_RETRIES=60
            until docker compose -f docker-compose.external-db.yml exec -T app wget --spider -q http://localhost:8080/actuator/health 2>/dev/null; do
              RETRY_COUNT=$((RETRY_COUNT+1))
              if [ $RETRY_COUNT -ge $MAX_RETRIES ]; then
                echo "ERROR: Health check failed after $MAX_RETRIES attempts!"
                echo ""
                echo "Final container status:"
                docker ps -a | grep creator-ledger-app
                echo ""
                echo "Full container logs:"
                docker logs creator-ledger-app --tail 100
                exit 1
              fi
              echo "Waiting for health check... ($RETRY_COUNT/$MAX_RETRIES)"
              sleep 2
            done

            echo "Cleaning up old images..."
            docker image prune -f

            echo "✅ Deployment successful!"
            docker ps | grep creator-ledger-app
